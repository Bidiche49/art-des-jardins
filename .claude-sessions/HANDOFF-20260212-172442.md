# Session Progress - HANDOFF-20260212-172442

**Projet:** art_et_jardin
**Date debut:** 2026-02-12
**Date handoff:** 2026-02-12 17:24
**Ticket lie:** FEAT-098 a FEAT-102 (Phases 15-19 migration Flutter)

---

## Objectif de la session

Continuer la migration Flutter de l'app mobile employe terrain. Le handoff d'entree demandait de completer les phases 15 a 19 (FEAT-098 a FEAT-102). 22 phases sur 25 sont maintenant terminees.

---

## Etat actuel

### Progression globale
88% complete (22/25 phases)

### Ce qui a ete fait CETTE SESSION
1. **FEAT-098 - Phase 15 - Onboarding Tour** (commit `d6c70de`)
   - `OnboardingRepository` (abstract) + `OnboardingRepositoryImpl` (AppPreferences + Dio)
   - API calls fire-and-forget (PATCH /auth/onboarding/step et /complete)
   - Steps par role : patron 8 steps, employe 5 steps
   - `OnboardingNotifier` (StateNotifier) : initialize(role), nextStep, previousStep, skip, complete
   - `OnboardingOverlay` : dark mask + tooltip card + progress bar + navigation
   - `OnboardingPage` : fullscreen PageView avec step content
   - AppShell integre : Stack(Scaffold + OnboardingOverlay), init deferred via addPostFrameCallback
   - `onboardingStep` ajoute a AppPreferences
   - App shell tests mis a jour (mock OnboardingRepository + registerFallbackValue)
   - **33 tests, flutter analyze clean**

2. **FEAT-099 - Phase 16 - Push Notifications FCM** (commit `7dfb555`)
   - `NotificationService` (abstract) + `NotificationServiceImpl` (Dio)
   - `PushNotificationPayload` : title, body, deepLink, data
   - Token registration : POST /notifications/subscribe (fcmToken + platform)
   - Token unregistration : POST /notifications/unsubscribe
   - Deep link resolution : devis, facture, intervention, client, chantier, absence -> routes
   - `NotificationNotifier` (StateNotifier) : initialize, onTokenRefresh, onLogout
   - Foreground message -> showLocalNotification, notification tap -> deep link
   - Stream providers : foregroundNotificationsProvider, notificationTapProvider
   - Endpoints ajoutes : notificationsSubscribe, notificationsUnsubscribe
   - **37 tests, flutter analyze clean**

### Ce qui reste a faire (3 phases)
1. **FEAT-101 - Phase 18 - UX Polish Pass** (~40 tests)
   - Shimmer loading skeletons (toutes listes)
   - Empty states (toutes listes vides)
   - Error states + retry (pattern uniforme)
   - Animations + transitions (staggered lists, hero, scale feedback)
   - Dark mode pass, terrain mode pass
   - Gestures natives, responsive tablet, accessibilite
   - J'ai DEJA LU le ticket en detail (160 lignes de specs)
   - J'etais SUR LE POINT de creer les shared widgets (AejShimmer, AejErrorRetry, etc.)

2. **FEAT-102 - Phase 19 - Performance + Production** (~30 tests)

3. **FEAT-100 - Phase 17 - Tests integration (DERNIER)** (~59 tests)

---

## Decisions prises (a respecter absolument)

| Decision | Raison | Impact |
|----------|--------|--------|
| build.yaml avec explicit_to_json: true | Serialisation nested freezed | Tous les modeles |
| SQLite sans FK constraints | Offline-first, pas de cascade | Drift tables |
| NativeDatabase.memory() pour tests | Tests rapides sans fichier | Tous tests Drift |
| StateNotifier pour notifiers | Machine d'etats explicite | Tous les notifiers |
| Backoff exponentiel 1s/2s/4s, max 3 retries | Standard retry | SyncService, RealtimeService |
| HTTP 409 = conflit | Detection sync conflicts | SyncService |
| IDs temporaires temp-{timestamp} | Mode offline | Tous les repositories |
| ConnectivityService.isOnline (pas isConnected) | Naming convention | Partout |
| SyncService.addToQueue(operation:, entity:, data:, entityId:) | Interface sync | Repos offline-first |
| appDatabaseProvider dans sync_providers.dart | Injection DB | Tests + runtime |
| AejBadgeVariant: primary/secondary/success/warning/error/info | Pas de neutral | Design system |
| AejEmptyState: description: (pas subtitle:) | Naming convention | Widget shared |
| IgnorePointer sur placeholder text dans GestureDetector | Eviter double-tap | Signature pad etc |
| HitTestBehavior.opaque sur GestureDetector transparentes | Idle reset partout | AppShell |
| AppPreferences deja existant dans data/local/preferences/ | SharedPreferences wrapper | Toute la persistence locale |
| terrainModeProvider + themeModeProvider dans core/theme/theme_provider.dart | Providers globaux theme | Settings + AppShell |
| AppConstants.idleTimeout = Duration(minutes: 15) | Timeout idle standard | IdleService |
| SyncService.syncAll() retourne SyncResult (pas void) | Besoin des compteurs | SyncService |
| broadcast stream events: await Future.delayed(Duration.zero) pour flush tests | Fiabilite tests streams | Tests realtime/notifications |
| OnboardingOverlay init deferred via addPostFrameCallback | Eviter "modify provider during build" | AppShell |
| Mock stream getters via override dans class Mock (pas when().thenReturn) | Mocktail limitation | Tests notification_providers |
| API calls onboarding fire-and-forget (pas await) | Non-bloquant si offline | OnboardingNotifier |

---

## Fichiers cles de la session

| Fichier | Type | Statut |
|---------|------|--------|
| `apps/mobile/PROGRESS.md` | Modifie | Source de verite avancement |
| `apps/mobile/lib/features/onboarding/domain/onboarding_repository.dart` | Cree | Interface + OnboardingStepData |
| `apps/mobile/lib/features/onboarding/data/onboarding_repository_impl.dart` | Cree | Impl + provider + steps data |
| `apps/mobile/lib/features/onboarding/presentation/providers/onboarding_providers.dart` | Cree | OnboardingNotifier + State |
| `apps/mobile/lib/features/onboarding/presentation/widgets/onboarding_overlay.dart` | Cree | Overlay dark + tooltip |
| `apps/mobile/lib/features/onboarding/presentation/pages/onboarding_page.dart` | Cree | PageView fullscreen |
| `apps/mobile/lib/services/notifications/notification_service.dart` | Cree | Service + impl + payload |
| `apps/mobile/lib/services/notifications/notification_providers.dart` | Cree | NotificationNotifier + streams |
| `apps/mobile/lib/data/local/preferences/app_preferences.dart` | Modifie | +onboardingStep |
| `apps/mobile/lib/core/network/api_endpoints.dart` | Modifie | +onboarding +notifications endpoints |
| `apps/mobile/lib/shared/layouts/app_shell.dart` | Modifie | Stack + OnboardingOverlay |
| `apps/mobile/test/shared/layouts/app_shell_test.dart` | Modifie | +mock OnboardingRepository |
| `apps/mobile/test/features/onboarding/onboarding_providers_test.dart` | Cree | 20 tests |
| `apps/mobile/test/features/onboarding/onboarding_overlay_test.dart` | Cree | 13 tests |
| `apps/mobile/test/services/notifications/notification_service_test.dart` | Cree | 22 tests |
| `apps/mobile/test/services/notifications/notification_providers_test.dart` | Cree | 15 tests |

---

## Architecture et patterns de reference

### Structure feature standard (Clean Architecture)
```
features/{name}/
├── domain/          # Interface repository
├── data/            # Impl + provider
└── presentation/
    ├── providers/   # StateNotifier + State + providers
    ├── pages/       # Pages completes
    └── widgets/     # Widgets specifiques feature
```

### Pattern StateNotifier
```dart
class XxxNotifier extends StateNotifier<XxxState> {
  XxxNotifier({required XxxRepository repository})
    : _repository = repository, super(const XxxState());
  // Methods mutate state via state = state.copyWith(...)
}

final xxxNotifierProvider = StateNotifierProvider<XxxNotifier, XxxState>((ref) {
  return XxxNotifier(repository: ref.read(xxxRepositoryProvider));
});
```

### Pattern Test
```dart
class MockXxxRepository extends Mock implements XxxRepository {}
// setUp: when().thenReturn/thenAnswer
// Pour stream getters: override dans la class Mock directement
// registerFallbackValue pour les enums/classes custom avec any()
// Widget tests: ProviderScope(overrides: [...])
```

---

## Etat du repo

- **Branche:** master
- **1051 tests passent** (0 failures)
- **flutter analyze:** 0 issues
- **Derniers commits:**
  - `7dfb555` feat(mobile): add push notifications FCM service [FEAT-099]
  - `d6c70de` feat(mobile): add onboarding tour [FEAT-098]

---

## Prochaines etapes

1. **FEAT-101 - UX Polish Pass** : Creer les widgets shared (AejShimmer, AejErrorRetry, AejDataStateBuilder, animations), puis les tests (~40 tests)
2. **FEAT-102 - Performance + Production** : Optimisations, lazy loading, cache strategies (~30 tests)
3. **FEAT-100 - Tests integration (DERNIER)** : Tests E2E flows complets (~59 tests)
4. Commit chaque phase separement avec pattern `feat(mobile): ... [FEAT-XXX]`
5. Mettre a jour PROGRESS.md + deplacer tickets PENDING -> DONE + INDEX.md apres chaque phase

---

## Commandes utiles

```bash
cd /Users/ntardy/Dev/Projets_perso/art_et_jardin/apps/mobile
flutter analyze                          # Doit etre clean (0 issues)
flutter test                             # 1051 tests doivent passer
flutter test test/features/onboarding/   # 33 tests onboarding
flutter test test/services/notifications/ # 37 tests notifications
cat PROGRESS.md                          # Suivi avancement complet
ls lib/features/                         # Toutes les features
ls lib/shared/widgets/                   # 14 widgets design system
```
