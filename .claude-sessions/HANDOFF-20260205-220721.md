# Session Progress - HANDOFF-20260205-220721

**Projet:** art_et_jardin
**Date debut:** 2026-02-05 ~21:10 (reprise session precedente)
**Date handoff:** 2026-02-05 22:07
**Ticket lie:** Tests application PWA + corrections bugs

---

## Objectif de la session

Reprendre les tests de l'application complete (PWA + API) apres implementation de 120 tickets. Corriger les bugs rencontres lors des tests utilisateur sur Mac et iPhone.

---

## Etat actuel

### Progression globale
90% complete - Tous les bugs critiques corriges, un dernier bug en attente (TemplateSelector)

### Ce qui a ete fait

**Bug 1 - Calendrier qui saute en boucle (CORRIGE):**
- Cause: boucle infinie dans `Calendar.tsx` - `loadInterventions` dependait de `employeeColorMap` qui dependait de `employees` mis a jour par `loadInterventions`
- Fix: construction de la color map localement dans `loadInterventions` au lieu de dependre du `useMemo` externe
- Fichier: `apps/pwa/src/pages/Calendar.tsx` (lignes ~159-216)
- Dependance changee de `[date, employeeColorMap]` a `[date]` seulement

**Bug 2 - iPhone Network Error (IDENTIFIE - limitation iOS):**
- Cause: en mode Partage de connexion iPhone, l'iPhone ne peut PAS acceder aux appareils connectes a son propre hotspot (limitation iOS)
- Solution appliquee: URL API dynamique basee sur `window.location.hostname` (fonctionnera sur WiFi commun)
- 8 fichiers modifies pour remplacer fallback `localhost:3000` par `window.location.hostname:3000`
- Supprime `.env.local`, commente `VITE_API_URL` dans `.env`

**Bug 3 - Erreur planification intervention (CORRIGE - 3 sous-bugs):**
- Sous-bug A: Format heures - PWA envoyait `heureDebut: "08:00"` (HH:MM), API attendait ISO datetime
  - Fix: transformation date+HH:MM -> ISO dans `interventionsApi.create()` et `.update()`
- Sous-bug B: `req.user.sub` undefined dans TOUS les controllers
  - Cause: `JwtStrategy.validate()` retourne l'objet `user` (avec `.id`) pas le payload JWT (avec `.sub`)
  - Fix: ajoute `sub: user.id` dans le retour de `jwt.strategy.ts`
  - Note: aussi change `req.user.sub` -> `req.user.id` dans `interventions.controller.ts` (redondant mais OK)
- Sous-bug C: champs non-whitelisted rejetes par API
  - Cause: `forbidNonWhitelisted: true` dans NestJS + PWA envoyait `responsableId`, `equipeIds` absents du DTO
  - Fix: envoi uniquement des champs acceptes par le DTO dans `interventionsApi.create()` et `.update()`

**Bug 4 - IDs seed non-UUID (CORRIGE):**
- Cause: seed utilisait `chantier-1`, `client-pro-1` etc. au lieu d'UUIDs
- API rejetait avec `@IsUUID()` validation
- Fix: seed.ts mis a jour avec vrais UUIDs (constantes `SEED_IDS`)
- Base re-seedee, anciens records non-UUID supprimes

### Ce qui reste a faire

1. **Bug TemplateSelector.tsx:163** - `templates.map is not a function`
   - Erreur dans `DevisBuilder` > `TemplateSelector`
   - Le composant recoit `templates` qui n'est pas un tableau
   - Probablement l'endpoint `/api/v1/templates` retourne un format different de ce qu'attend le composant
   - A verifier: `TemplateSelector.tsx:163` et l'API templates

2. **Commit atomique** des corrections (demande utilisateur)

3. **Tests iPhone** - necessitent un vrai WiFi commun (pas hotspot)

---

## Decisions prises

| Decision | Raison | Impact |
|----------|--------|--------|
| Color map locale dans loadInterventions | Casser la boucle de dependance cyclique | Calendar.tsx |
| URL API dynamique window.location.hostname | Supporter automatiquement localhost ET IP reseau | 8 fichiers api/client PWA |
| sub: user.id dans JwtStrategy | Corriger tous les controllers d'un coup plutot que modifier 40+ occurrences | jwt.strategy.ts |
| Champs explicites dans interventionsApi | Eviter forbidNonWhitelisted rejects | interventions.ts (PWA) |
| UUIDs dans seed.ts | Compatibilite avec @IsUUID() validation | seed.ts + DB reseedee |

---

## Fichiers modifies

### API (apps/api/src/)
| Fichier | Type | Description |
|---------|------|-------------|
| `modules/auth/strategies/jwt.strategy.ts` | Modifie | Ajoute `sub: user.id` dans validate() |
| `modules/interventions/interventions.controller.ts` | Modifie | `req.user.sub` -> `req.user.id` |
| `modules/stats/stats.controller.ts` | Cree (session precedente) | Endpoints stats mock |
| `modules/stats/stats.module.ts` | Cree (session precedente) | Module stats |
| `app.module.ts` | Modifie (session precedente) | Import StatsModule |
| `modules/templates/templates.controller.ts` | Modifie (session precedente) | GET /categories endpoint |

### PWA (apps/pwa/src/)
| Fichier | Type | Description |
|---------|------|-------------|
| `pages/Calendar.tsx` | Modifie | Fix boucle infinie - color map locale |
| `api/interventions.ts` | Modifie | Transform HH:MM->ISO + champs explicites |
| `api/client.ts` | Modifie | URL API dynamique hostname |
| `api/calendar.ts` | Modifie | URL API dynamique + fix port 3001->3000 |
| `api/messaging.ts` | Modifie | URL API dynamique hostname |
| `api/clientPortal.ts` | Modifie | URL API dynamique hostname |
| `pages/SignerDevis.tsx` | Modifie | URL API dynamique hostname |
| `hooks/useRealtimeUpdates.ts` | Modifie | URL API dynamique hostname |
| `db/sync.ts` | Modifie | URL API dynamique hostname |
| `db/offlineApi.ts` | Modifie | URL API dynamique hostname |
| `vite.config.ts` | Modifie (session precedente) | SW disabled |

### Database
| Fichier | Type | Description |
|---------|------|-------------|
| `packages/database/prisma/seed.ts` | Modifie | UUIDs au lieu d'IDs textuels |

---

## Blocages / Points d'attention

1. **TemplateSelector.tsx:163** - `templates.map is not a function` - BUG NON RESOLU
   - L'endpoint `/api/v1/templates` retourne probablement un objet pagine `{ data: [...], meta: {...} }` au lieu d'un tableau
   - Le composant `TemplateSelector` fait `templates.map()` directement
   - Fix probable: extraire `.data` de la reponse, ou verifier le format retourne

2. **iPhone** - Ne peut PAS tester en mode partage de connexion (limitation iOS). Besoin d'un WiFi commun.

3. **Commit** - L'utilisateur a demande un commit atomique documenter des corrections. Non fait car handoff.

4. **Prisma client regen** - Un `prisma generate` a ete necessaire apres le `migrate reset`. A refaire si probleme.

---

## Services actifs

- API: http://localhost:3000
- PWA: http://localhost:5173 (reseau: http://172.20.10.13:5173) - lance avec `npx vite --host` dans `apps/pwa/`
- PostgreSQL: localhost:5432 (Docker: art_et_jardin_db)
- Adminer: http://localhost:8080

---

## Credentials test

- patron@artjardin.fr / password123
- pierre.martin@artjardin.fr / password123
- lucas.bernard@artjardin.fr / password123

---

## Commandes utiles

```bash
# Services
docker ps                          # Verifier PostgreSQL
lsof -i :3000 -i :5173            # Verifier API + PWA

# Si besoin de relancer
pnpm dev:api                       # API NestJS
cd apps/pwa && npx vite --host     # PWA avec acces reseau

# Database
pnpm db:seed                       # Re-seeder
pnpm db:migrate                    # Migrations

# Test API
TOKEN=$(curl -s http://localhost:3000/api/v1/auth/login -X POST -H "Content-Type: application/json" -d '{"email":"patron@artjardin.fr","password":"password123"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['accessToken'])")
curl -s http://localhost:3000/api/v1/templates -H "Authorization: Bearer $TOKEN" | python3 -m json.tool
```
