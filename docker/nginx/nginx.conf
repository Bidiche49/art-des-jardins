# ===========================================
# Art & Jardin - Nginx Reverse Proxy
# Production configuration
# ===========================================

upstream api {
    server api:3000;
}

upstream vitrine {
    server vitrine:3001;
}

upstream pwa {
    server pwa:80;
}

# Rate limiting
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

# API - api.artjardin.fr
server {
    listen 80;
    server_name api.artjardin.fr;

    # Redirect to HTTPS (uncomment when SSL is configured)
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Rate limiting
        limit_req zone=api_limit burst=20 nodelay;
    }

    # Stricter rate limit for auth endpoints
    location /auth/login {
        proxy_pass http://api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        limit_req zone=login_limit burst=5 nodelay;
    }

    # Health check
    location /health {
        proxy_pass http://api;
        access_log off;
    }
}

# PWA - app.artjardin.fr
server {
    listen 80;
    server_name app.artjardin.fr;

    # Redirect to HTTPS (uncomment when SSL is configured)
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://pwa;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Site vitrine - artjardin.fr / www.artjardin.fr
server {
    listen 80;
    server_name artjardin.fr www.artjardin.fr;

    # Redirect to HTTPS (uncomment when SSL is configured)
    # return 301 https://$server_name$request_uri;

    # Redirect www to non-www
    if ($host = 'www.artjardin.fr') {
        return 301 http://artjardin.fr$request_uri;
    }

    location / {
        proxy_pass http://vitrine;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static assets
    location /_next/static {
        proxy_pass http://vitrine;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# Default server - return 444 for unknown hosts
server {
    listen 80 default_server;
    server_name _;
    return 444;
}
