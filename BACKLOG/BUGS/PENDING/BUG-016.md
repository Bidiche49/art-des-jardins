# BUG-016: Flux creation chantier et client casse — jamais persiste en BD

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** S
**Tags:** mobile, data, navigation
**Date creation:** 2026-02-26

---

## Description

Les formulaires de creation de chantier et de client ne persistent jamais les donnees en base. Le `onSubmit` du router fait simplement `context.pop(chantier/client)` sans appeler le repository. L'utilisateur croit que l'entite est creee (le formulaire se ferme), mais les donnees disparaissent au reboot.

## Cause racine

Dans `app_router.dart`, les routes de creation font :

```dart
// Chantier (lignes 139-151)
onSubmit: (chantier) {
  context.pop(chantier);  // Pop sans creation !
},

// Client (lignes 109-120)
onSubmit: (client) {
  context.pop(client);  // Pop sans creation !
},
```

De plus, les pages de liste utilisent `context.goNamed()` sans ecouter le resultat du pop, donc meme si le pop retournait des donnees, la liste ne se rafraichit pas.

## Fichiers concernes

### A modifier
- `apps/mobile/lib/core/router/app_router.dart` — Routes `clientCreate` et `chantierCreate` : appeler le repository avant le pop
- `apps/mobile/lib/features/clients/presentation/pages/clients_list_page.dart` — Invalider le provider apres navigation retour
- `apps/mobile/lib/features/chantiers/presentation/pages/chantiers_list_page.dart` — Idem

## Approche

Option A (recommandee) : Le `onSubmit` du router appelle le repository puis pop :
```dart
onSubmit: (client) async {
  await ref.read(clientsRepositoryProvider).create(client);
  ref.invalidate(clientsListNotifierProvider);
  context.pop();
},
```

Option B : Le formulaire lui-meme appelle le repository (deplace la logique dans le form).

## Criteres d'acceptation

- [ ] Creer un client → il est persiste en base locale ET visible dans la liste
- [ ] Creer un chantier → idem
- [ ] Creation offline → l'entite est ajoutee a la sync queue
- [ ] La liste se rafraichit immediatement apres creation
- [ ] Un SnackBar confirme la creation

## Tests de validation

- [ ] Test widget : remplir le formulaire client + submit → repository.create() appele
- [ ] Test widget : remplir le formulaire chantier + submit → repository.create() appele
- [ ] Test integration : creer un client → naviguer vers la liste → client visible
- [ ] Test integration : creer un chantier → naviguer vers la liste → chantier visible
