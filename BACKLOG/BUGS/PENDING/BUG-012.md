# BUG-012: Devis invisible apres creation + offline casse

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** L
**Tags:** mobile, offline, devis, data, sync
**Date creation:** 2026-02-25

---

## Description

Le module Devis de l'app Flutter presente plusieurs bugs critiques qui rendent l'experience inutilisable en conditions reelles (terrain sans reseau). Un paysagiste sur chantier doit pouvoir consulter ET creer des devis sans connexion — c'est une contrainte non-negociable du cahier des charges.

## Problemes identifies

### P1 — Devis invisible apres creation (BLOQUANT)

**Symptome:** Apres creation d'un devis (brouillon ou envoye), il n'apparait pas dans la liste des devis. L'utilisateur voit "Brouillon sauvegarde" mais la liste reste inchangee.

**Cause racine:** `devisListNotifierProvider` n'est jamais invalide apres creation/modification. Le provider Riverpod garde son ancien etat en memoire et ne sait pas qu'un nouveau devis existe en base locale.

**Fichiers concernes:**
- `apps/mobile/lib/features/devis/presentation/pages/devis_builder_page.dart` — `_saveBrouillon()` et `_envoyerDevis()` ne font aucun `ref.invalidate(devisListNotifierProvider)`
- `apps/mobile/lib/features/devis/presentation/providers/devis_providers.dart` — `saveBrouillon()` et `envoyerDevis()` dans le builder notifier n'invalident pas la liste

**Fix:** Ajouter `ref.invalidate(devisListNotifierProvider)` apres chaque operation de creation/modification/suppression reussie.

### P2 — Lignes de devis non persistees localement (OFFLINE CASSE)

**Symptome:** Les lignes de devis (LigneDevis) ne sont jamais sauvegardees en base locale Drift. En offline, ouvrir un devis existant affiche un devis VIDE (sans lignes).

**Cause racine:**
- Pas de `LigneDevisTable` dans la base Drift
- Pas de `LigneDevisDao`
- `getLignes()` retourne `[]` quand offline (aucun fallback local)
- Les lignes existent uniquement en memoire (dans le builder state) ou sur l'API

**Fichiers a creer:**
- `apps/mobile/lib/data/local/database/tables/lignes_devis_table.dart`
- `apps/mobile/lib/data/local/database/daos/lignes_devis_dao.dart`

**Fichiers a modifier:**
- `apps/mobile/lib/data/local/database/app_database.dart` — Ajouter la table + DAO
- `apps/mobile/lib/features/devis/data/devis_repository_impl.dart` — `getLignes()` doit lire en local, `_upsertLocal()` doit aussi persister les lignes

### P3 — ID temporaire + numero "BROUILLON" en offline

**Symptome:** Devis crees offline ont `id = 'temp-{timestamp}'` et `numero = 'BROUILLON'`. A la synchronisation, l'API retourne un vrai ID et numero — mais l'ancien enregistrement local avec le temp ID reste en base, creant un doublon.

**Cause racine:** `_createOffline()` utilise un ID temporaire sans mecanisme de reconciliation post-sync. Quand la sync queue envoie le POST, l'API retourne le vrai devis, mais le callback de sync ne supprime pas l'ancien temp record.

**Fichiers concernes:**
- `apps/mobile/lib/features/devis/data/devis_repository_impl.dart` — `_createOffline()`
- `apps/mobile/lib/features/sync/` — Le sync engine doit reconcilier temp ID → real ID

**Fix:** Apres sync reussie, supprimer le record temp et inserer le record reel. Mettre a jour aussi les references (lignes liees au temp ID).

### P4 — Pas de rafraichissement reactif apres sync

**Symptome:** Meme quand la synchro passe (retour en ligne), la liste des devis n'est pas rafraichie automatiquement. L'utilisateur doit faire pull-to-refresh manuellement.

**Fix:** Le sync engine doit notifier les providers concernes apres chaque sync reussie (via un stream ou callback d'invalidation).

## Criteres d'acceptation

### Online
- [ ] Creer un brouillon → il apparait immediatement dans la liste (filtre "Tous" et "Brouillon")
- [ ] Envoyer un devis → il apparait avec statut "Envoye"
- [ ] Modifier un devis → la liste reflete les changements instantanement

### Offline — Consultation
- [ ] Ouvrir un devis existant offline → toutes les lignes sont visibles
- [ ] La liste des devis est disponible offline (depuis le cache local)
- [ ] Les totaux (HT, TVA, TTC) sont corrects

### Offline — Creation
- [ ] Creer un brouillon offline → il apparait dans la liste avec numero "BROUILLON"
- [ ] Les lignes du brouillon offline sont persistees localement
- [ ] Rouvrir le brouillon offline → les lignes sont toujours la

### Synchronisation
- [ ] Retour en ligne → le devis temp est synchronise avec l'API
- [ ] Apres sync, le temp ID est remplace par le vrai ID (pas de doublon)
- [ ] Le numero "BROUILLON" est remplace par le vrai numero (ex: DEV-2026-001)
- [ ] La liste se rafraichit automatiquement apres sync
- [ ] Les lignes sont correctement liees au nouveau vrai ID

### Non-regression
- [ ] Les devis existants (deja en base) continuent de fonctionner
- [ ] La modification d'un devis existant fonctionne online et offline
- [ ] Le filtrage par statut fonctionne correctement

## Fichiers concernes

### A modifier
- `apps/mobile/lib/features/devis/presentation/pages/devis_builder_page.dart`
- `apps/mobile/lib/features/devis/presentation/providers/devis_providers.dart`
- `apps/mobile/lib/features/devis/data/devis_repository_impl.dart`
- `apps/mobile/lib/data/local/database/app_database.dart`

### A creer
- `apps/mobile/lib/data/local/database/tables/lignes_devis_table.dart`
- `apps/mobile/lib/data/local/database/daos/lignes_devis_dao.dart`

### A verifier
- `apps/mobile/lib/features/sync/` — Reconciliation temp ID → real ID
- `apps/mobile/lib/domain/models/devis.dart` — Model OK
- `apps/mobile/lib/domain/models/ligne_devis.dart` — Model OK

## Analyse / Approche

### Etape 1 — Fix immediat : invalidation provider (P1)
Ajouter `ref.invalidate(devisListNotifierProvider)` dans `_saveBrouillon()` et `_envoyerDevis()`. Fix rapide, impact immediat.

### Etape 2 — Table locale LigneDevis (P2)
1. Creer `LigneDevisTable` (Drift) avec les champs du model
2. Creer `LigneDevisDao` (CRUD basique)
3. Enregistrer dans `AppDatabase`
4. Modifier `_upsertLocal()` pour persister les lignes avec le devis
5. Modifier `getLignes()` pour lire depuis la BD locale en fallback

### Etape 3 — Reconciliation offline (P3)
1. Dans le sync callback post-create, supprimer le temp record
2. Inserer le record avec le vrai ID et numero
3. Mettre a jour les lignes liees (foreign key devisId)
4. Invalider les providers concernes

### Etape 4 — Rafraichissement reactif post-sync (P4)
1. Ajouter un stream/callback dans le sync engine
2. Le repository ecoute les events de sync
3. Invalide automatiquement les providers apres sync d'un devis

## Tests de validation

- [ ] Test unitaire: invalidation provider apres create
- [ ] Test unitaire: LigneDevisDao CRUD
- [ ] Test unitaire: _upsertLocal persiste les lignes
- [ ] Test unitaire: getLignes fallback local
- [ ] Test unitaire: reconciliation temp ID → real ID
- [ ] Test integration: creer brouillon online → visible dans liste
- [ ] Test integration: creer brouillon offline → visible dans liste
- [ ] Test integration: sync offline → temp ID remplace, pas de doublon
- [ ] Test integration: ouvrir devis offline → lignes presentes
- [ ] Test widget: liste se rafraichit apres creation
