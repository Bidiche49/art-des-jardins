# BUG-019: Conflits 409 non geres par le sync engine

**Type:** Bug
**Statut:** A faire
**Priorite:** Haute
**Complexite:** M
**Tags:** mobile, offline, sync, data
**Date creation:** 2026-02-26

---

## Description

Quand le serveur retourne un 409 Conflict (meme entite modifiee online ET offline simultanement), le sync engine marque simplement l'operation comme `'pending'` et la retente indefiniment. Il ne cree jamais de `SyncConflict` pour l'utilisateur et ne le notifie pas. Le `ConflictService` existe mais n'est jamais appele depuis le sync engine.

## Cause racine

Dans `sync_service.dart` (lignes 101-107) :

```dart
if (e.response?.statusCode == 409) {
  conflicts++;
  await _syncQueueDao.updateOne(
    item.copyWith(status: 'pending', lastError: const Value('conflict')),
  );
  // Pas de SyncConflict cree, pas de notification UI
}
```

Le `ConflictService` (dans `conflict_service.dart`) a toute la logique pour creer un `SyncConflict` avec strategies de resolution (local, server, merge), mais il n'est jamais integre au flux de sync.

## Fichiers concernes

### A modifier
- `apps/mobile/lib/services/sync/sync_service.dart` — Quand 409, creer un SyncConflict via ConflictService + emettre event
- `apps/mobile/lib/services/sync/sync_service.dart` — Marquer comme `'conflict'` au lieu de `'pending'` pour eviter retry infini

## Approche

1. Quand `statusCode == 409` :
   - Extraire les donnees serveur depuis la reponse
   - Extraire les donnees locales depuis l'item de queue
   - Creer un `SyncConflict` via `ConflictService.createSyncConflict()`
   - Marquer l'item comme `status: 'conflict'`
   - Emettre un event pour l'UI (page de resolution de conflits)
2. L'UI de resolution de conflits existe deja (`conflict_resolution_page.dart`) — s'assurer qu'elle fonctionne avec ce flux

## Criteres d'acceptation

- [ ] 409 Conflict → item marque `'conflict'` (pas `'pending'`)
- [ ] Un `SyncConflict` est cree avec les versions locale et serveur
- [ ] L'UI de resolution de conflits affiche le conflit
- [ ] Apres resolution (local/server/merge), l'item est re-synchronise
- [ ] Pas de retry infini sur les 409

## Tests de validation

- [ ] Test unitaire : 409 → status 'conflict' + SyncConflict cree
- [ ] Test unitaire : resolution 'server' → donnees serveur appliquees localement
- [ ] Test unitaire : resolution 'local' → donnees locales renvoyees au serveur
- [ ] Test integration : modifier meme entite online et offline → conflit detecte → resolution → sync OK
