# BUG-003: Endpoint /health/detailed expose sans authentification

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** XS
**Tags:** security, api
**Date creation:** 2026-02-12

---

## Description

L'endpoint `/health/detailed` est accessible publiquement et expose des informations sensibles sur l'infrastructure : etat de la BDD, services connectes, versions, etc. Un attaquant peut utiliser ces infos pour cartographier l'infrastructure.

Les endpoints `/health`, `/health/live` et `/health/ready` peuvent rester publics (probes Kubernetes/monitoring).

## Criteres d'acceptation

- [ ] `/health/detailed` protege par `@UseGuards(JwtAuthGuard, RolesGuard)` et `@Roles('patron')`
- [ ] `/health`, `/health/live`, `/health/ready` restent publics
- [ ] Test avec token patron → 200
- [ ] Test sans token → 401

## Fichiers concernes

- `apps/api/src/modules/health/health.controller.ts`

## Analyse / Approche

```typescript
@Get('detailed')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(UserRole.patron)
getDetailedHealth() {
  return this.healthService.getDetailedStatus();
}
```

Note : Si BUG-001 est corrige (JwtAuthGuard global), il suffit d'ajouter `@Roles('patron')` et de NE PAS mettre `@Public()`.

## Tests de validation

- [ ] GET /health → 200 sans token
- [ ] GET /health/live → 200 sans token
- [ ] GET /health/ready → 200 sans token
- [ ] GET /health/detailed → 401 sans token
- [ ] GET /health/detailed → 403 avec token employe
- [ ] GET /health/detailed → 200 avec token patron
