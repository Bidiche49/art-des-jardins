# BUG-001: JwtAuthGuard non configure comme APP_GUARD global

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** S
**Tags:** security, api, auth
**Date creation:** 2026-02-12

---

## Description

Le `JwtAuthGuard` n'est PAS configure comme garde global via `APP_GUARD` dans `app.module.ts`. Seul le `CustomThrottlerGuard` est global. Cela signifie que **toutes les routes sont publiques par defaut** sauf celles qui declarent explicitement `@UseGuards(JwtAuthGuard)`.

Si un developpeur oublie le decorateur sur un nouveau controller, les endpoints sont exposes sans authentification.

## Reproduction

1. Ouvrir `apps/api/src/app.module.ts:145-150`
2. Constater que seul `CustomThrottlerGuard` est dans `APP_GUARD`
3. Tout nouveau endpoint sans `@UseGuards()` est accessible sans token

## Criteres d'acceptation

- [ ] `JwtAuthGuard` ajoute comme `APP_GUARD` dans `app.module.ts`
- [ ] Decorateur `@Public()` cree pour les routes publiques
- [ ] Routes publiques annotees : login, register, health, health/live, health/ready, signature publique, webhook
- [ ] Toutes les routes protegees testees avec et sans token
- [ ] Tests e2e passes

## Fichiers concernes

- `apps/api/src/app.module.ts` - ajouter APP_GUARD
- `apps/api/src/common/decorators/public.decorator.ts` - creer decorateur @Public
- `apps/api/src/modules/auth/guards/jwt-auth.guard.ts` - modifier pour supporter @Public
- `apps/api/src/modules/health/health.controller.ts` - ajouter @Public
- `apps/api/src/modules/auth/auth.controller.ts` - ajouter @Public sur login/register
- `apps/api/src/modules/signature/signature.controller.ts` - ajouter @Public sur verification

## Analyse / Approche

```typescript
// 1. Creer le decorateur @Public()
// apps/api/src/common/decorators/public.decorator.ts
import { SetMetadata } from '@nestjs/common';
export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);

// 2. Modifier JwtAuthGuard pour supporter @Public
canActivate(context: ExecutionContext) {
  const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
    context.getHandler(),
    context.getClass(),
  ]);
  if (isPublic) return true;
  return super.canActivate(context);
}

// 3. Ajouter dans app.module.ts providers
{ provide: APP_GUARD, useClass: JwtAuthGuard },
```

## Tests de validation

- [ ] Route GET /health accessible sans token (200)
- [ ] Route POST /auth/login accessible sans token (200/401)
- [ ] Route GET /clients retourne 401 sans token
- [ ] Route GET /clients retourne 200 avec token valide
- [ ] Aucun endpoint protege n'est accessible sans token
- [ ] Tests e2e existants passent toujours
