# BUG-005: Tokens JWT lus depuis localStorage au lieu du store Zustand

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** S
**Tags:** security, pwa, auth
**Date creation:** 2026-02-12

---

## Description

Dans plusieurs fichiers de la PWA, les tokens JWT sont recuperes directement via `localStorage.getItem('token')` au lieu d'utiliser le store Zustand (`useAuthStore`). Le store auth est correctement configure mais n'est pas utilise de maniere coherente.

Problemes :
- Exposition directe aux attaques XSS
- Incoherence entre le token du store et celui de localStorage
- Le store peut avoir un token rafraichi que localStorage n'a pas

## Criteres d'acceptation

- [ ] Tous les `localStorage.getItem('token')` remplaces par `useAuthStore.getState().accessToken`
- [ ] Aucun acces direct a localStorage pour les tokens dans toute la PWA
- [ ] Intercepteur Axios central utilise comme seule source de token
- [ ] Tests de sync offline passes avec le nouveau pattern

## Fichiers concernes

- `apps/pwa/src/db/sync.ts:140,226` - localStorage.getItem('token')
- `apps/pwa/src/db/offlineApi.ts:21,73,110,207,247` - localStorage.getItem('token')

## Analyse / Approche

```typescript
// Avant (dangereux)
Authorization: `Bearer ${localStorage.getItem('token')}`

// Apres (securise)
import { useAuthStore } from '@/stores/auth';
const { accessToken } = useAuthStore.getState();
Authorization: `Bearer ${accessToken}`
```

L'intercepteur Axios dans `api/client.ts` gere deja le token correctement. Les fichiers offline devraient utiliser le meme pattern.

## Tests de validation

- [ ] Grep `localStorage.getItem('token')` retourne 0 resultats dans src/
- [ ] Sync offline fonctionne correctement apres modification
- [ ] Le token est bien rafraichi partout apres un refresh
- [ ] Deconnexion vide bien le token partout
