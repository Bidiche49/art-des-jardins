# BUG-017: Module factures incomplet — read-only + lignes non persistees

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** L
**Tags:** mobile, offline, data, factures
**Date creation:** 2026-02-26

---

## Description

Le module factures est actuellement 100% read-only. L'interface `FacturesRepository` ne definit aucune methode `create()`, `update()` ou `delete()`. De plus, les lignes de facture ne sont jamais persistees localement (pas de table Drift), et certains fallback offline sont absents.

## Problemes identifies

### P1 — Interface repository incomplete (BLOQUANT)

`FacturesRepository` ne definit que des methodes de lecture :
- `getAll()`, `getById()`, `getByStatut()`, `getEnRetard()`, `getPdfUrl()`
- Manquent : `create()`, `update()`, `delete()`, `getLignes()`

**Fichier:** `apps/mobile/lib/features/factures/domain/factures_repository.dart`

### P2 — Lignes de facture non persistees localement

Identique au probleme P2 de BUG-012 (devis). Pas de `LignesFacturesTable` ni de `LignesFacturesDao`. Une facture ouverte offline est vide.

**Fichiers a creer:**
- `apps/mobile/lib/data/local/database/tables/lignes_factures_table.dart`
- `apps/mobile/lib/data/local/database/daos/lignes_factures_dao.dart`

### P3 — Fallback offline incomplet

`getByStatut()` et `getEnRetard()` echouent silencieusement sans fallback local quand l'API est injoignable.

**Fichier:** `apps/mobile/lib/features/factures/data/factures_repository_impl.dart` (lignes 66-67, 86)

### P4 — Champs manquants dans FacturesTable

La table Drift manque 3 champs presents dans le modele :
- `referencePaiement`
- `mentionsLegales`
- `deletedAt`

**Fichier:** `apps/mobile/lib/data/local/database/tables/factures_table.dart`

## Fichiers concernes

### A creer
- `apps/mobile/lib/data/local/database/tables/lignes_factures_table.dart`
- `apps/mobile/lib/data/local/database/daos/lignes_factures_dao.dart`

### A modifier
- `apps/mobile/lib/features/factures/domain/factures_repository.dart` — Ajouter create/update/delete/getLignes
- `apps/mobile/lib/features/factures/data/factures_repository_impl.dart` — Implementer CRUD + fallback offline + persistance lignes
- `apps/mobile/lib/data/local/database/tables/factures_table.dart` — Ajouter 3 colonnes manquantes
- `apps/mobile/lib/data/local/database/app_database.dart` — Enregistrer table + DAO lignes factures

## Criteres d'acceptation

- [ ] `FacturesRepository` expose create/update/delete/getLignes
- [ ] create/update/delete fonctionnent online ET offline (avec temp ID + sync queue)
- [ ] Les lignes de facture sont persistees localement (consultation offline)
- [ ] `getByStatut()` et `getEnRetard()` ont un fallback local
- [ ] Les 3 champs manquants sont ajoutes a la table Drift
- [ ] Schema version incrementee avec migration

## Tests de validation

- [ ] Test unitaire : CRUD repository (online + offline)
- [ ] Test unitaire : LignesFacturesDao CRUD
- [ ] Test unitaire : getLignes fallback local
- [ ] Test unitaire : getByStatut fallback local
- [ ] Test unitaire : getEnRetard fallback local
- [ ] Test integration : creer facture offline → visible dans liste → sync → real ID
