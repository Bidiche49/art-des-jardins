# BUG-018: Photos interventions non fonctionnelles offline

**Type:** Bug
**Statut:** A faire
**Priorite:** Critique
**Complexite:** L
**Tags:** mobile, offline, photos, interventions
**Date creation:** 2026-02-26

---

## Description

Le systeme de photos pour les interventions est non fonctionnel. Le callback `PhotoCapture.onCapture` est vide (commentaire), les photos ne sont pas persistees localement pour consultation offline, les photos en queue sont stockees dans `/tmp` (perdues au redemarrage), et `PhotoQueueService` n'est jamais orchestre par le sync engine.

## Problemes identifies

### P1 — Callback PhotoCapture vide (BLOQUANT)

Dans `intervention_detail_page.dart` (lignes 170-172), le callback est un no-op :

```dart
PhotoCapture(
  onCapture: (type) {
    // Photo capture handled by PhotoService
  },
),
```

L'utilisateur clique sur "Avant/Pendant/Apres" mais rien ne se passe.

### P2 — Photos non consultables offline

`getPhotosForIntervention()` dans `photo_service.dart` fait un GET API sans fallback local. Offline, retourne une liste vide. Il n'existe pas de table Drift pour cacher les photos telecharges.

### P3 — Photos en queue perdues au redemarrage

Les photos offline sont stockees avec un chemin dans `/tmp` (volatil). Un crash ou redemarrage de l'app = perte definitive des photos non synchronisees.

**Fix:** Utiliser `getApplicationDocumentsDirectory()` au lieu de `getTemporaryDirectory()`.

### P4 — PhotoQueueService jamais orchestre

`PhotoQueueService.processQueue()` n'est jamais appele automatiquement. Contrairement a `SyncService` qui a `AutoSyncController`, les photos n'ont aucun mecanisme de sync automatique.

### P5 — PhotoQueueService non injecte dans les providers

Le service n'est jamais fourni via Riverpod. Il n'existe pas dans `main.dart` ni dans les providers.

## Fichiers concernes

### A creer
- `apps/mobile/lib/data/local/database/tables/intervention_photos_table.dart` — Cache local des photos
- `apps/mobile/lib/data/local/database/daos/intervention_photos_dao.dart`
- `apps/mobile/lib/services/photo/photo_queue_controller.dart` — Auto-sync des photos (comme AutoSyncController)

### A modifier
- `apps/mobile/lib/features/interventions/presentation/pages/intervention_detail_page.dart` — Implementer callback PhotoCapture
- `apps/mobile/lib/services/photo/photo_service.dart` — Fallback local pour getPhotos, stockage dans documents dir
- `apps/mobile/lib/services/photo/photo_queue_service.dart` — Utiliser documents dir, robustesse
- `apps/mobile/lib/services/sync/sync_service.dart` — Integrer photo sync dans syncAll()
- `apps/mobile/lib/services/sync/sync_providers.dart` — Fournir PhotoQueueController
- `apps/mobile/lib/data/local/database/app_database.dart` — Enregistrer table + DAO photos

## Criteres d'acceptation

- [ ] Cliquer sur PhotoCapture (Avant/Pendant/Apres) ouvre la camera et sauvegarde la photo
- [ ] Photo prise online → upload immediat + cache local
- [ ] Photo prise offline → stockee dans documents dir (pas /tmp) + ajoutee a la queue
- [ ] Photos consultables offline (depuis le cache local)
- [ ] Retour en ligne → photos en queue uploadees automatiquement
- [ ] Photos survivent un redemarrage de l'app
- [ ] Photos en queue visibles dans l'UI avec badge "En attente"

## Tests de validation

- [ ] Test unitaire : PhotoCapture callback appelle PhotoService
- [ ] Test unitaire : getPhotosForIntervention fallback cache local
- [ ] Test unitaire : photo offline stockee dans documents dir
- [ ] Test unitaire : PhotoQueueController process au retour en ligne
- [ ] Test integration : prendre photo offline → redemarrer app → photo toujours en queue → sync → photo visible
