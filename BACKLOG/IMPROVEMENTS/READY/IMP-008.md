# IMP-008: Backup chiffre

**Type:** Improvement
**Statut:** Pret
**Priorite:** Moyenne
**Complexite:** S
**Tags:** security, backup
**Date creation:** 2026-02-03
**Phase:** 13

---

## Description

Chiffrer les backups de la base de donnees avant upload sur S3.

## Contexte

Les backups contiennent toutes les donnees de l'entreprise. Meme si S3 est prive, un backup chiffre ajoute une couche de protection en cas de:
- Mauvaise configuration bucket S3
- Compromission des credentials S3
- Obligation legale de protection des donnees

## Criteres d'acceptation

- [ ] Chiffrement AES-256-GCM du fichier backup
- [ ] Cle de chiffrement differente de la BDD
- [ ] Cle stockee separement (pas sur S3)
- [ ] Compression avant chiffrement (gzip)
- [ ] Script de restoration avec dechiffrement
- [ ] Verification integrite apres dechiffrement

## Fichiers concernes

- `apps/api/src/modules/backup/backup.service.ts`
- `apps/api/src/modules/backup/backup-crypto.service.ts` (nouveau)
- `apps/api/src/config/env.validation.ts`

## Analyse / Approche

Format du backup chiffre:
```
[4 bytes: version] [12 bytes: IV] [16 bytes: auth tag] [encrypted data]
```

```typescript
// backup-crypto.service.ts
import { createCipheriv, createDecipheriv, randomBytes } from 'crypto';
import { createGzip, createGunzip } from 'zlib';
import { pipeline } from 'stream/promises';

async encryptBackup(inputPath: string, outputPath: string): Promise<void> {
  const iv = randomBytes(12);
  const cipher = createCipheriv('aes-256-gcm', this.key, iv);

  // Version header + IV
  const header = Buffer.alloc(16);
  header.writeUInt32BE(1, 0); // version 1
  iv.copy(header, 4);

  await pipeline(
    fs.createReadStream(inputPath),
    createGzip(),
    cipher,
    fs.createWriteStream(outputPath)
  );

  // Append auth tag
  const authTag = cipher.getAuthTag();
  fs.appendFileSync(outputPath, authTag);
}
```

Variable env:
```
BACKUP_ENCRYPTION_KEY=your-32-byte-key-here
```

## Tests de validation

- [ ] Backup produit fichier chiffre
- [ ] Fichier illisible sans cle
- [ ] Restoration dechiffre correctement
- [ ] Integrite verifiee (auth tag)
- [ ] Compression effective (taille reduite)
