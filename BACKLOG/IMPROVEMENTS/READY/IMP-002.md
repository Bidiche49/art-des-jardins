# IMP-002: Rate limiting global par IP

**Type:** Improvement
**Statut:** Pret
**Priorite:** Critique
**Complexite:** S
**Tags:** security, api
**Date creation:** 2026-02-03
**Phase:** 11

---

## Description

Implementer un rate limiting global par adresse IP pour proteger l'API contre les attaques par force brute et DDoS leger.

## Contexte

Actuellement le rate limiting est par endpoint (ex: login). Un attaquant peut multiplier les requetes sur differentes routes. Un rate limiting global par IP limite le nombre total de requetes par IP sur une fenetre de temps.

## Criteres d'acceptation

- [ ] Rate limit global: 100 requetes/minute par IP
- [ ] Rate limit auth: 10 requetes/minute par IP (login, register, 2fa)
- [ ] Headers X-RateLimit-* retournes dans les reponses
- [ ] Reponse 429 Too Many Requests avec Retry-After
- [ ] Whitelist IPs internes (health checks)
- [ ] Redis storage pour environnement multi-instance
- [ ] Logs des IPs bloquees

## Fichiers concernes

- `apps/api/src/main.ts`
- `apps/api/src/modules/auth/auth.controller.ts`
- `apps/api/src/common/guards/throttle.guard.ts` (nouveau)

## Analyse / Approche

```typescript
// Utiliser @nestjs/throttler
import { ThrottlerModule, ThrottlerGuard } from '@nestjs/throttler';

ThrottlerModule.forRoot({
  ttl: 60,
  limit: 100,
  storage: new ThrottlerStorageRedisService(redis),
});

// Decorator pour endpoints sensibles
@Throttle(10, 60) // 10 req/min pour auth
```

## Tests de validation

- [ ] 101eme requete en 1 minute retourne 429
- [ ] Headers X-RateLimit-Remaining decroit
- [ ] Apres TTL, compteur reset
- [ ] Whitelist IP fonctionne
