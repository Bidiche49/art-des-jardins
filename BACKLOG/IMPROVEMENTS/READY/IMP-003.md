# IMP-003: Rotation automatique refresh tokens

**Type:** Improvement
**Statut:** Pret
**Priorite:** Haute
**Complexite:** S
**Tags:** security, auth
**Date creation:** 2026-02-03
**Phase:** 12

---

## Description

Implementer la rotation automatique des refresh tokens: a chaque utilisation d'un refresh token, un nouveau est genere et l'ancien est invalide.

## Contexte

Actuellement, un refresh token vole reste valide jusqu'a expiration. Avec la rotation:
- Chaque refresh token n'est utilisable qu'une seule fois
- Si un attaquant utilise un token vole, l'utilisateur legitime detecte l'intrusion (son token devient invalide)
- Detection des tentatives de replay

## Criteres d'acceptation

- [ ] Nouveau refresh token genere a chaque /auth/refresh
- [ ] Ancien refresh token invalide immediatement
- [ ] Stockage refresh tokens en BDD (pas seulement JWT)
- [ ] Detection replay: si token deja utilise -> invalider TOUS les tokens de l'utilisateur
- [ ] Famille de tokens (lineage) pour tracer les rotations
- [ ] Cleanup automatique des tokens expires

## Fichiers concernes

- `packages/database/prisma/schema.prisma`
- `apps/api/src/modules/auth/auth.service.ts`
- `apps/api/src/modules/auth/refresh-token.service.ts` (nouveau)

## Analyse / Approche

```prisma
model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  familyId    String   // Groupe de tokens lies
  usedAt      DateTime?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revokedAt   DateTime?
}
```

Logique rotation:
1. Recevoir refresh token
2. Verifier en BDD: existe, non utilise, non expire, non revoque
3. Si deja utilise -> ALERTE: revoquer toute la famille
4. Marquer comme utilise
5. Generer nouveau token dans meme famille
6. Retourner nouvel access + refresh token

## Tests de validation

- [ ] Refresh genere nouveau token
- [ ] Ancien token refuse apres rotation
- [ ] Replay detecte et tous tokens revoques
- [ ] Cleanup supprime tokens expires
