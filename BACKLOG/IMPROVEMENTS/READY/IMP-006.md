# IMP-006: Expiration sessions inactives

**Type:** Improvement
**Statut:** Pret
**Priorite:** Moyenne
**Complexite:** S
**Tags:** security, auth, ux
**Date creation:** 2026-02-03
**Phase:** 12

---

## Description

Deconnecter automatiquement les utilisateurs apres une periode d'inactivite configurable.

## Contexte

Pour la securite, une session laissee ouverte sur un poste partage est un risque. L'expiration automatique apres inactivite reduit ce risque.

## Criteres d'acceptation

- [ ] Timeout inactivite configurable par role:
  - Patron: 30 min (donnees sensibles)
  - Employe: 2h (usage terrain)
  - Client portail: 1h
- [ ] Detection activite: clics, scrolls, frappes clavier
- [ ] Avertissement 2 min avant expiration avec option "Rester connecte"
- [ ] Redirection vers login apres expiration
- [ ] Option "Se souvenir de moi" pour bypass (device de confiance)
- [ ] Configurable dans les parametres admin

## Fichiers concernes

- `apps/pwa/src/hooks/useIdleTimer.ts` (nouveau)
- `apps/pwa/src/components/IdleWarningModal.tsx` (nouveau)
- `apps/pwa/src/contexts/AuthContext.tsx`
- `apps/api/src/config/env.validation.ts`

## Analyse / Approche

```typescript
// Hook idle timer
const useIdleTimer = (timeout: number, onIdle: () => void) => {
  const [remaining, setRemaining] = useState(timeout);

  useEffect(() => {
    const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
    const resetTimer = () => setRemaining(timeout);

    events.forEach(e => window.addEventListener(e, resetTimer));

    const interval = setInterval(() => {
      setRemaining(r => {
        if (r <= 0) {
          onIdle();
          return 0;
        }
        return r - 1000;
      });
    }, 1000);

    return () => {
      events.forEach(e => window.removeEventListener(e, resetTimer));
      clearInterval(interval);
    };
  }, [timeout, onIdle]);

  return { remaining, isWarning: remaining < 120000 };
};
```

## Tests de validation

- [ ] Session expire apres inactivite
- [ ] Activite reset le timer
- [ ] Warning affiche 2 min avant
- [ ] "Rester connecte" prolonge la session
- [ ] "Se souvenir de moi" desactive le timeout
