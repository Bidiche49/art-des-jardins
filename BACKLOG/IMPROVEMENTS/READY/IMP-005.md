# IMP-005: Detection anomalies login

**Type:** Improvement
**Statut:** Pret
**Priorite:** Moyenne
**Complexite:** M
**Tags:** security, auth
**Date creation:** 2026-02-03
**Phase:** 12
**Automatisable:** OUI (avec attention)

---

## ⚠️ ATTENTION - SERVICE EXTERNE ⚠️

> **Dependance a un service tiers pour la geolocalisation IP**
>
> Ce ticket utilise un service externe (ip-api.com) pour geolocalisaer les IPs.
> Le service gratuit a des limites (45 req/min) et peut changer ses conditions.
>
> **Points de vigilance:**
> - Verifier les conditions d'utilisation de ip-api.com
> - Prevoir un fallback si le service est indisponible
> - Alternative payante: MaxMind GeoLite2 (base locale, plus fiable)
>
> **Pas bloquant pour l'automatisation** mais a surveiller en production.

---

## Description

Detecter et alerter lors de connexions depuis une nouvelle IP, un nouveau device, ou un nouveau pays.

## User Story

**En tant que** patron
**Je veux** etre alerte si quelqu'un se connecte a mon compte depuis un nouvel appareil
**Afin de** detecter rapidement une compromission de compte

## Criteres d'acceptation

- [ ] Stocker les devices connus par utilisateur (fingerprint)
- [ ] Stocker les IPs connues par utilisateur
- [ ] Geolocalisation IP (pays, ville)
- [ ] Email d'alerte si nouvelle IP/device/pays
- [ ] Option "C'etait moi" dans l'email pour valider
- [ ] Option "Ce n'etait pas moi" pour revoquer sessions
- [ ] Historique des connexions visible dans profil
- [ ] Possibilite de revoquer des devices

## Fichiers concernes

- `packages/database/prisma/schema.prisma` (KnownDevice)
- `apps/api/src/modules/auth/device-tracking.service.ts` (nouveau)
- `apps/api/src/modules/auth/auth.service.ts`
- `apps/api/src/modules/mail/templates/new-login-alert.hbs` (nouveau)

## Analyse / Approche

```prisma
model KnownDevice {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  fingerprint String   // Hash de User-Agent + autres signaux
  name        String?  // "Chrome sur Windows"
  lastIp      String
  lastCountry String?
  lastCity    String?
  lastUsedAt  DateTime
  trustedAt   DateTime?
  createdAt   DateTime @default(now())

  @@unique([userId, fingerprint])
}
```

Fingerprint basique:
- User-Agent
- Accept-Language
- Timezone (via header ou JS)

Geolocation: utiliser service gratuit (ip-api.com) ou MaxMind GeoLite2.

## Tests de validation

- [ ] Premiere connexion = nouveau device enregistre
- [ ] Connexion meme device = pas d'alerte
- [ ] Connexion nouveau device = email d'alerte
- [ ] "Ce n'etait pas moi" revoque toutes les sessions
