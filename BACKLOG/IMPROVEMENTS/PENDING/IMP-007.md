# IMP-007: Chiffrement donnees sensibles en BDD

**Type:** Improvement
**Statut:** A faire
**Priorite:** Moyenne
**Complexite:** M
**Tags:** security, data
**Date creation:** 2026-02-03
**Phase:** 13
**Automatisable:** NON

---

## ðŸš¨ DANGER - MIGRATION DONNEES CRITIQUES ðŸš¨

> **RISQUE DE PERTE DE DONNEES IRREVERSIBLE**
>
> Ce ticket implique de **MODIFIER DES DONNEES EXISTANTES** en production.
> Une erreur de migration peut rendre les donnees **ILLISIBLES DEFINITIVEMENT**.
>
> **Pourquoi ce ticket n'est PAS automatisable:**
> 1. Migration de donnees existantes = operation irreversible
> 2. Si la cle de chiffrement est perdue = donnees perdues a jamais
> 3. Rollback impossible une fois les donnees chiffrees
> 4. Tests sur copie de prod obligatoires avant deploiement
>
> **Action requise AVANT implementation:**
> - [ ] Backup complet de la BDD (et tester la restauration!)
> - [ ] Environnement de test avec copie des vraies donnees
> - [ ] Procedure de rollback documentee
> - [ ] Stockage securise de la cle de chiffrement (pas dans le code!)
> - [ ] Plan de recuperation si cle perdue
>
> **NE JAMAIS EXECUTER EN AUTOMATIQUE SUR PRODUCTION**

---

## Description

Chiffrer les donnees sensibles (SIRET, RIB, IBAN) au repos dans la base de donnees.

## Contexte

En cas de fuite de la BDD, les donnees sensibles ne doivent pas etre lisibles. Le chiffrement au repos (at-rest encryption) avec une cle geree separement protege ces donnees.

Donnees sensibles identifiees:
- SIRET/SIREN clients pro
- RIB/IBAN clients
- Numeros de telephone (RGPD)

## Criteres d'acceptation

- [ ] Chiffrement AES-256-GCM pour les champs sensibles
- [ ] Cle de chiffrement dans variable d'environnement
- [ ] Dechiffrement transparent via decorateur Prisma
- [ ] Migration des donnees existantes (chiffrer)
- [ ] Rotation de cle possible (re-chiffrer)
- [ ] Recherche sur champs chiffres via hash deterministe

## Fichiers concernes

- `packages/database/src/encryption.service.ts` (nouveau)
- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/xxx_encrypt_sensitive_data/`

## Analyse / Approche

```typescript
// Middleware Prisma pour chiffrement transparent
prisma.$use(async (params, next) => {
  // Avant creation/update: chiffrer
  if (params.action === 'create' || params.action === 'update') {
    if (params.model === 'Client') {
      params.args.data.siret = encrypt(params.args.data.siret);
      params.args.data.iban = encrypt(params.args.data.iban);
    }
  }

  const result = await next(params);

  // Apres lecture: dechiffrer
  if (params.action === 'findUnique' || params.action === 'findMany') {
    if (params.model === 'Client') {
      decrypt(result, ['siret', 'iban']);
    }
  }

  return result;
});
```

Pour la recherche, stocker un hash (SHA-256 tronque) a cote:
- `siret_hash` pour recherche exacte
- Pas de recherche partielle possible (acceptable pour SIRET/IBAN)

## Tests de validation

- [ ] Donnees chiffrees en BDD (verif directe SQL)
- [ ] Lecture via API retourne donnees claires
- [ ] Recherche par SIRET fonctionne
- [ ] Migration existants OK
- [ ] Rotation cle fonctionne
