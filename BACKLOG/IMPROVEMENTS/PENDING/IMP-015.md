# IMP-015: Refactoriser useOfflineSync pour utiliser Dexie

**Type:** Improvement
**Statut:** A faire
**Priorite:** Haute
**Complexite:** S
**Tags:** pwa, offline
**Date creation:** 2026-02-12

---

## Description

Le hook `useOfflineSync` stocke les operations dans `localStorage` alors que le projet a une infrastructure Dexie complete avec une table `syncQueue` dediee dans `db/schema.ts`. Double systeme incoherent, limite de 5-10MB localStorage.

## Criteres d'acceptation

- [ ] `useOfflineSync` refactorise pour utiliser `syncService` existant dans `db/sync.ts`
- [ ] Plus aucun `localStorage` pour les operations offline
- [ ] Sync offline fonctionne correctement (online → offline → online)
- [ ] Compteur d'operations en attente correct

## Fichiers concernes

- `apps/pwa/src/hooks/useOfflineSync.ts:16,24` - localStorage usage
- `apps/pwa/src/db/sync.ts` - syncService existant a reutiliser
- `apps/pwa/src/db/schema.ts` - table syncQueue Dexie

## Analyse / Approche

```typescript
import { syncService } from '@/db/sync';

export function useOfflineSync() {
  const { isOnline } = useUIStore();

  useEffect(() => {
    if (isOnline) {
      syncService.syncAll();
    }
  }, [isOnline]);

  return {
    addPendingOperation: syncService.addToQueue.bind(syncService),
    syncPendingOperations: syncService.syncAll.bind(syncService),
  };
}
```

## Tests de validation

- [ ] Passer offline, creer un client, repasser online → sync OK
- [ ] Compteur pending operations correct
- [ ] `grep "localStorage" apps/pwa/src/hooks/useOfflineSync.ts` → 0 resultats
