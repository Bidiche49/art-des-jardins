# IMP-004: Audit log centralise securite

**Type:** Improvement
**Statut:** Split
**Priorite:** Haute
**Complexite:** M
**Tags:** security, api, monitoring
**Date creation:** 2026-02-03
**Date split:** 2026-02-03
**Phase:** 12

---

## Note

**Ce ticket a ete split en 4 sous-tickets pour execution automatisee:**

- **IMP-004-A**: SecurityAuditService - Types et service de base (S)
- **IMP-004-B**: Integration des events securite dans AuthService (S)
- **IMP-004-C**: Systeme d'alertes securite (S)
- **IMP-004-D**: Dashboard securite et export CSV (S)

Ordre d'execution: A -> B -> C -> D (dependencies)

---

## Description originale

Centraliser tous les logs de securite (tentatives login, actions sensibles, erreurs auth) dans un systeme dedie avec alertes.

## Contexte

Actuellement les audit logs existent mais sont disperses. Pour la securite, il faut:
- Un log specifique securite
- Correlation des evenements
- Alertes en temps reel
- Retention longue duree

## Criteres d'acceptation

- [ ] Nouveau type d'audit log: SECURITY
- [ ] Events logged:
  - LOGIN_SUCCESS, LOGIN_FAILED
  - 2FA_ENABLED, 2FA_DISABLED, 2FA_FAILED
  - PASSWORD_CHANGED, PASSWORD_RESET_REQUESTED
  - TOKEN_REFRESH, TOKEN_REVOKED
  - PERMISSION_DENIED
  - RATE_LIMIT_EXCEEDED
  - SUSPICIOUS_ACTIVITY
- [ ] Metadata: IP, User-Agent, geolocation (optionnel)
- [ ] Alerte email si > 5 LOGIN_FAILED en 10 min pour meme user
- [ ] Dashboard securite dans admin
- [ ] Export CSV des logs securite

## Fichiers concernes

- `apps/api/src/modules/audit/security-audit.service.ts` (nouveau)
- `apps/api/src/modules/auth/auth.service.ts`
- `apps/api/src/modules/alerts/security-alert.service.ts` (nouveau)

## Analyse / Approche

```typescript
interface SecurityEvent {
  type: SecurityEventType;
  userId?: string;
  ip: string;
  userAgent: string;
  metadata: Record<string, any>;
  severity: 'info' | 'warning' | 'critical';
  timestamp: Date;
}

// Detection patterns
const SUSPICIOUS_PATTERNS = {
  bruteforce: { event: 'LOGIN_FAILED', threshold: 5, window: '10m' },
  accountTakeover: { event: '2FA_DISABLED', followedBy: 'PASSWORD_CHANGED', window: '1h' },
};
```

## Tests de validation

- [ ] Tous les events securite sont logges
- [ ] Alerte envoyee apres 5 echecs login
- [ ] Dashboard affiche les logs
- [ ] Export CSV fonctionne
