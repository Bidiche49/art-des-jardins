# IMP-047: Conversion HEIC vers JPEG cote client pour apercu PhotoUpload

**Type:** Improvement
**Statut:** Fait
**Priorite:** Moyenne
**Complexite:** S
**Tags:** ui, ux, mobile
**Date creation:** 2026-02-16
**Date resolution:** 2026-02-16

---

## Description

Dans le composant `PhotoUpload`, les fichiers HEIC/HEIF (format natif iPhone) affichaient un placeholder gris avec le texte "HEIC" au lieu d'un veritable apercu miniature. De plus, toutes les miniatures (JPG/PNG/WebP inclus) affichaient l'image brute pleine resolution dans un conteneur 80x80, causant un rendu degrade (aliasing, moire).

## Solution implementee

### Pipeline de thumbnails universel (Canvas 160x160)

Toutes les images passent par `generateThumbnail()` avec 3 strategies en cascade :

1. **Chargement natif + Canvas resize** — Fonctionne pour JPG/PNG/WebP partout et HEIC sur Safari (support natif). Instantane.
2. **Decodage HEIC via `heic-to/next` → ImageBitmap → Canvas** — Fallback pour HEIC sur Chrome/Firefox. Dynamic import, charge uniquement si necessaire. Utilise `type: 'bitmap'` pour eviter le round-trip JPEG encode/decode.
3. **`URL.createObjectURL(file)` brut** — Dernier recours si Canvas est bloque (extensions anti-fingerprint). Pas de resize, mais l'image est visible.

### Bibliotheque : `heic-to` (v1.4.2)

- Remplace `heic2any` (v0.0.4) qui etait incompatible webpack/Next.js (Worker inline via `URL.createObjectURL(blob)`)
- Export `heic-to/next` dedie a Next.js
- WASM libheif sans Worker, compatible CSP
- Dynamic import : zero impact sur le bundle initial

### Details techniques

- **Thumbnail 160x160** (2x retina pour affichage 80x80) en JPEG quality 0.75
- **Center crop carre** via Canvas pour un rendu propre
- **Spinner** pendant la generation
- **Fallback "Apercu indisponible"** si toutes les strategies echouent
- **ObjectURL revoquees** a la suppression du fichier et au demontage du composant
- **Fichier original envoye tel quel** au serveur (pas de conversion pour l'envoi)

## Criteres d'acceptation

- [x] Un fichier HEIC uploade affiche un vrai apercu miniature
- [x] Un spinner s'affiche pendant la conversion (~1-3s sur Chrome)
- [x] Toutes les images (JPG/PNG/WebP/HEIC) passent par le Canvas 160x160
- [x] Le fichier original est envoye tel quel au serveur
- [x] Si la conversion echoue, l'upload fonctionne quand meme
- [x] `heic-to` est charge en dynamic import (pas dans le bundle initial)
- [x] Les objectURL sont proprement revoquees
- [x] Pas de regression sur les uploads classiques

## Fichiers concernes

- `apps/vitrine/src/components/PhotoUpload.tsx` (reecriture du rendu miniatures)
- `apps/vitrine/package.json` (ajout `heic-to`, retrait `heic2any`)

## Tests de validation

- [x] Upload .heic sur Safari → chargement natif, pas de lib externe chargee
- [x] Upload .heic sur Chrome → fallback heic-to, spinner puis apercu
- [x] Upload .jpg/.png → thumbnail Canvas instantane
- [x] Extensions bloquantes → fallback image brute (pas "indisponible")
- [x] Upload 3 images → conversions paralleles
