# IMP-006: Expiration sessions inactives

**Type:** Improvement
**Statut:** Fait
**Priorite:** Moyenne
**Complexite:** S
**Tags:** security, auth, ux
**Date creation:** 2026-02-03
**Phase:** 12

---

## Description

Deconnecter automatiquement les utilisateurs apres une periode d'inactivite configurable.

## Contexte

Pour la securite, une session laissee ouverte sur un poste partage est un risque. L'expiration automatique apres inactivite reduit ce risque.

## Criteres d'acceptation

- [x] Timeout inactivite configurable par role:
  - Patron: 30 min (donnees sensibles)
  - Employe: 2h (usage terrain)
  - Client portail: 1h
- [x] Detection activite: clics, scrolls, frappes clavier
- [x] Avertissement 2 min avant expiration avec option "Rester connecte"
- [x] Redirection vers login apres expiration
- [x] Option "Se souvenir de moi" pour bypass (device de confiance)
- [ ] Configurable dans les parametres admin (a faire dans un ticket futur)

## Fichiers concernes

- `apps/pwa/src/hooks/useIdleTimer.ts` (nouveau)
- `apps/pwa/src/components/IdleWarningModal.tsx` (nouveau)
- `apps/pwa/src/contexts/AuthContext.tsx`
- `apps/api/src/config/env.validation.ts`

## Analyse / Approche

```typescript
// Hook idle timer
const useIdleTimer = (timeout: number, onIdle: () => void) => {
  const [remaining, setRemaining] = useState(timeout);

  useEffect(() => {
    const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
    const resetTimer = () => setRemaining(timeout);

    events.forEach(e => window.addEventListener(e, resetTimer));

    const interval = setInterval(() => {
      setRemaining(r => {
        if (r <= 0) {
          onIdle();
          return 0;
        }
        return r - 1000;
      });
    }, 1000);

    return () => {
      events.forEach(e => window.removeEventListener(e, resetTimer));
      clearInterval(interval);
    };
  }, [timeout, onIdle]);

  return { remaining, isWarning: remaining < 120000 };
};
```

## Tests de validation

- [x] Session expire apres inactivite
- [x] Activite reset le timer
- [x] Warning affiche 2 min avant
- [x] "Rester connecte" prolonge la session
- [x] "Se souvenir de moi" desactive le timeout

## Implementation realisee

**Fichiers crees:**
- `apps/pwa/src/hooks/useIdleTimer.ts` - Hook principal avec gestion du timeout
- `apps/pwa/src/hooks/useIdleTimer.test.ts` - 13 tests unitaires
- `apps/pwa/src/components/IdleWarningModal.tsx` - Modal d'avertissement
- `apps/pwa/src/components/IdleTimerProvider.tsx` - Provider pour integration

**Fichiers modifies:**
- `apps/pwa/src/stores/auth.ts` - Ajout de `rememberMe` state
- `apps/pwa/src/stores/auth.test.ts` - Tests pour rememberMe
- `apps/api/src/config/env.validation.ts` - Config SESSION_IDLE_TIMEOUT_*

**Commits:**
- feat(pwa): add useIdleTimer hook for session timeout [IMP-006]
- feat(pwa): add IdleWarningModal component [IMP-006]
- feat(api): add session idle timeout config per role [IMP-006]
- feat(pwa): add IdleTimerProvider and rememberMe to auth store [IMP-006]
- test(pwa): add unit tests for useIdleTimer and rememberMe [IMP-006]

**Date completion:** 2026-02-03
