# IMP-002: Rate limiting global par IP

**Type:** Improvement
**Statut:** Fait
**Priorite:** Critique
**Complexite:** S
**Tags:** security, api
**Date creation:** 2026-02-03
**Date completion:** 2026-02-03
**Phase:** 11

---

## Description

Implementer un rate limiting global par adresse IP pour proteger l'API contre les attaques par force brute et DDoS leger.

## Contexte

Actuellement le rate limiting est par endpoint (ex: login). Un attaquant peut multiplier les requetes sur differentes routes. Un rate limiting global par IP limite le nombre total de requetes par IP sur une fenetre de temps.

## Criteres d'acceptation

- [x] Rate limit global: 100 requetes/minute par IP
- [x] Rate limit auth: 10 requetes/minute par IP (login, register, 2fa)
- [x] Headers X-RateLimit-* retournes dans les reponses
- [x] Reponse 429 Too Many Requests avec Retry-After
- [x] Whitelist IPs internes (health checks)
- [ ] Redis storage pour environnement multi-instance (non implemente - utilise stockage memoire)
- [x] Logs des IPs bloquees

## Implementation

### Fichiers crees/modifies

- `apps/api/src/common/guards/custom-throttler.guard.ts` - Guard personnalise
- `apps/api/src/common/guards/index.ts` - Export du guard
- `apps/api/src/app.module.ts` - Utilisation du CustomThrottlerGuard
- `apps/api/src/modules/auth/auth.controller.ts` - Rate limit 10 req/min sur endpoints auth
- `apps/api/src/common/guards/custom-throttler.guard.spec.ts` - 24 tests unitaires

### Fonctionnalites

1. **Whitelist IPs internes**: localhost (127.0.0.1, ::1), et plages privees (10.x, 172.16-31.x, 192.168.x)
2. **Headers X-RateLimit-***: X-RateLimit-Limit, X-RateLimit-Policy, X-RateLimit-Remaining, X-RateLimit-Reset
3. **Retry-After header**: Indique quand reessayer apres un 429
4. **Logging**: Log des IPs bloquees avec method, URL et User-Agent
5. **X-Forwarded-For**: Detection correcte de l'IP client derriere un proxy

### Note sur Redis

Le stockage Redis n'a pas ete implemente car:
- L'application n'utilise pas encore Redis
- Le stockage memoire suffit pour une instance unique
- Redis sera ajoute lors du passage en multi-instance (IMP-002-B potentiel)

## Tests de validation

- [x] 101eme requete en 1 minute retourne 429
- [x] Headers X-RateLimit-Remaining decroit
- [x] Apres TTL, compteur reset
- [x] Whitelist IP fonctionne

24 tests unitaires couvrent ces scenarios.
