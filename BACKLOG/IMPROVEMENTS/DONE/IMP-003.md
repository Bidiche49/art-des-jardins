# IMP-003: Rotation automatique refresh tokens

**Type:** Improvement
**Statut:** Fait
**Priorite:** Haute
**Complexite:** S
**Tags:** security, auth
**Date creation:** 2026-02-03
**Date completion:** 2026-02-03
**Phase:** 12

---

## Description

Implementer la rotation automatique des refresh tokens: a chaque utilisation d'un refresh token, un nouveau est genere et l'ancien est invalide.

## Contexte

Actuellement, un refresh token vole reste valide jusqu'a expiration. Avec la rotation:
- Chaque refresh token n'est utilisable qu'une seule fois
- Si un attaquant utilise un token vole, l'utilisateur legitime detecte l'intrusion (son token devient invalide)
- Detection des tentatives de replay

## Criteres d'acceptation

- [x] Nouveau refresh token genere a chaque /auth/refresh
- [x] Ancien refresh token invalide immediatement
- [x] Stockage refresh tokens en BDD (pas seulement JWT)
- [x] Detection replay: si token deja utilise -> invalider TOUS les tokens de l'utilisateur
- [x] Famille de tokens (lineage) pour tracer les rotations
- [x] Cleanup automatique des tokens expires

## Fichiers concernes

- `packages/database/prisma/schema.prisma`
- `apps/api/src/modules/auth/auth.service.ts`
- `apps/api/src/modules/auth/refresh-token.service.ts` (nouveau)

## Analyse / Approche

```prisma
model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  familyId    String   // Groupe de tokens lies
  usedAt      DateTime?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revokedAt   DateTime?
}
```

Logique rotation:
1. Recevoir refresh token
2. Verifier en BDD: existe, non utilise, non expire, non revoque
3. Si deja utilise -> ALERTE: revoquer toute la famille
4. Marquer comme utilise
5. Generer nouveau token dans meme famille
6. Retourner nouvel access + refresh token

## Tests de validation

- [x] Refresh genere nouveau token
- [x] Ancien token refuse apres rotation
- [x] Replay detecte et tous tokens revoques
- [x] Cleanup supprime tokens expires

---

## Implementation

### Commits

1. `feat(database): add familyId and usedAt to RefreshToken for rotation [IMP-003]`
2. `feat(api): add RefreshTokenService for token rotation [IMP-003]`
3. `feat(api): integrate token rotation in AuthService [IMP-003]`
4. `feat(api): register RefreshTokenService in auth module [IMP-003]`
5. `test(api): update auth tests for token rotation [IMP-003]`

### Fichiers modifies

| Fichier | Type | Description |
|---------|------|-------------|
| `packages/database/prisma/schema.prisma` | Modifie | Ajout champs familyId et usedAt |
| `apps/api/src/modules/auth/refresh-token.service.ts` | Cree | Service de rotation des tokens |
| `apps/api/src/modules/auth/auth.service.ts` | Modifie | Integration rotation |
| `apps/api/src/modules/auth/auth.module.ts` | Modifie | Registration RefreshTokenService |
| `apps/api/src/modules/auth/refresh-token.service.spec.ts` | Cree | 15 tests unitaires |
| `apps/api/src/modules/auth/auth.service.spec.ts` | Modifie | Mise a jour tests |

### Fonctionnalites implementees

- **createRefreshToken**: Cree un token avec familyId unique
- **rotateRefreshToken**: Marque ancien token comme utilise, genere nouveau
- **Detection replay**: Si token deja utilise, revoque TOUTE la famille
- **revokeTokenFamily**: Revoque tous les tokens d'une famille
- **revokeAllUserTokens**: Revoque tous les tokens d'un utilisateur
- **cleanupExpiredTokens**: Supprime tokens expires/revoques

### Tests (15 nouveaux + 13 modifies)

Tous les tests passent (99 tests dans le module auth).
